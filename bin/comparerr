#!/usr/bin/python3
import sys
import json
import argparse

if __name__ == "__main__":

    parser = argparse.ArgumentParser(description="Compare 2 reports of errors in JSON comparerr format")
    parser.add_argument("old_report", type=str, help="Path to old report.")
    parser.add_argument("new_report", type=str, help="Path to new report.")
    parser.add_argument("--generate-report", action="store_true", help="Generate report even if there is no new error.")

    args = parser.parse_args()

    with open(args.old_report,"r") as pl_file:
        old_errs_list = list(dict(json.load(pl_file)).values())

    with open(args.new_report,"r") as pl_file:
        new_errs_list = list(dict(json.load(pl_file)).values())

    old_contexts = [err["context"] for err in old_errs_list]
    new_contexts = [err["context"] for err in new_errs_list]

    solved_indexes = []
    broken_indexes = []

    for index, context in enumerate(old_contexts):
        if context not in new_contexts:
            solved_indexes.append(index)

    for index, context in enumerate(new_contexts):
        if context not in old_contexts:
            broken_indexes.append(index)

    if len(broken_indexes) > 0 or args.generate_report:
        print("New errors:")
        for index in broken_indexes:
            print("file: %s" % new_errs_list[index]["path"])
            print("line: %s" % new_errs_list[index]["line"])
            print("message: %s" % new_errs_list[index]["msg"])
            print("context:\n %s" % new_errs_list[index]["context"])
        print("Fixed errors:")
        for index in solved_indexes:
            print("file: %s" % old_errs_list[index]["path"])
            print("line: %s" % old_errs_list[index]["line"])
            print("message: %s" % old_errs_list[index]["msg"])
            print("context:\n %s" % old_errs_list[index]["context"])

    if len(broken_indexes) > 0:
        sys.exit(1)
    else:
        sys.exit(0)
